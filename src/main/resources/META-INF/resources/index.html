<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta nameHibernate="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baldur's Forge Assistant Chat</title>
    <link rel="stylesheet" href="/webjars/font-awesome/css/all.min.css">
    <script src="/webjars/jquery/jquery.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #333639;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: #e8e8e8;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: none;
            background-color: transparent;
            position: relative;
        }
        .header {
            padding: 15px;
            background-color: #333639;
            color: white;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 3px solid #BCAE79;
        }
        .header img {
            height: 40px;
            margin-right: 15px;
        }
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 90px;
            background-color: transparent;
        }
        .input-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 1160px;
            display: flex;
            background-color: #444750;
            border-radius: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            padding: 5px;
        }
        #message-input {
            flex-grow: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            background-color: transparent;
            color: #e8e8e8;
            outline: none;
        }
        #message-input::placeholder {
            color: #aaa;
        }
        .button-group {
            display: flex;
            padding-right: 10px;
            align-items: center;
        }
        .btn {
            width: 38px;
            height: 38px;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #ask-button {
            background-color: #59666C;
        }
        #ask-button:hover {
            background-color: #4a575c;
        }
        #data-button {
            background-color: #BCAE79;
            color: #333;
        }
        #data-button:hover {
            background-color: #a89c69;
        }
        .btn i {
            font-size: 18px;
        }
        .clear-btn {
            background: none;
            border: none;
            color: #aaaaaa;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
        }
        .clear-btn:hover {
            color: #e8e8e8;
        }
        .clear-btn i {
            font-size: 18px;
        }
        .message {
            margin-bottom: 20px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #4e5c64;
            margin-left: auto;
            border-radius: 18px;
            border-bottom-right-radius: 4px;
            color: #fff;
            padding: 12px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .assistant-message {
            margin-right: auto;
            color: #e8e8e8;
            padding: 0 0 0 15px;
            border-left: 3px solid #59666C;
        }
        .data-message {
            margin-right: auto;
            color: #e8e8e8;
            padding: 0 0 0 15px;
            border-left: 3px solid #BCAE79;
            max-width: 90%;
        }
        .loading-container {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            transition: opacity 0.5s ease-out;
            position: relative;
        }
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(188,174,121,0.2);
            border-radius: 50%;
            border-top-color: #BCAE79;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            margin-top: 5px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        pre {
            background-color: #2a2d30;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
            color: #e8e8e8;
            border-left: 2px solid #BCAE79;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 14px;
            background-color: #2a2d30;
        }
        table th {
            background-color: #59666C;
            color: white;
            text-align: left;
            padding: 8px;
            border: 1px solid #444;
        }
        table td {
            padding: 8px;
            border: 1px solid #444;
            color: #e8e8e8;
        }
        table tr:nth-child(even) {
            background-color: #333639;
        }
        .table-container {
            overflow-x: auto;
            max-width: 100%;
        }
        .expandable-json {
            cursor: pointer;
            color: #BCAE79;
            text-decoration: underline;
            font-style: italic;
        }
        .nested-table {
            margin-top: 8px;
            margin-left: 15px;
            border-left: 2px solid #BCAE79;
        }
        .expand-collapse-btn {
            background: none;
            border: none;
            color: #BCAE79;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 5px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <img src="/favicon.ico" alt="Baldur's Gate 3 Logo">
        <h1>Baldur's Forge Assistant</h1>
    </div>
    <div class="chat-container" id="chat-container">
        <div class="message assistant-message">
            Hello! I'm your Baldur's Forge Assistant. Ask me anything about Baldur's Gate 3 items.
        </div>
    </div>
    <div class="input-container">
        <input type="text" id="message-input" placeholder="Ask a question about your data..."
               autocomplete="off" autofocus>
        <div class="button-group">
            <button id="ask-button" class="btn" title="Ask a question">
                <i class="fas fa-comment"></i>
            </button>
            <button id="data-button" class="btn" title="Get data">
                <i class="fas fa-table"></i>
            </button>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    const $chatContainer = $('#chat-container');
    const $messageInput = $('#message-input');

    // Add clear button to chat container
    const $clearButton = $('<button>', {
        id: 'clear-button',
        class: 'clear-btn',
        html: '<i class="fas fa-trash"></i>',
        css: { display: 'none' }
    });

    // Function to update clear button visibility
    function updateClearButtonVisibility() {
        if ($chatContainer.children().length > 2) {
            $clearButton.css('display', 'flex');
            $chatContainer.append($clearButton);
        } else {
            $clearButton.css('display', 'none');
        }
    }

    // Function to add a message to the chat
    function addMessage(text, isUser) {
        const $messageDiv = $('<div>', {
            class: `message ${isUser ? 'user-message' : 'assistant-message'}`
        });

        // Basic Markdown-like formatting for code blocks
        $messageDiv.html(text.replace(/```([\s\S]*?)```/g, '<pre>$1</pre>'));

        $chatContainer.append($messageDiv);
        $chatContainer.scrollTop($chatContainer[0].scrollHeight);
        updateClearButtonVisibility();
    }

    // Convert a string to a JSON object if possible
    function asJsonObject(str) {
        try {
            const json = JSON.parse(str);
            return typeof json === 'object' && json;
        } catch (e) {
            return null;
        }
    }

    // Function to create expandable JSON cells
    function createExpandableJson(value, $parentElement) {
        if (typeof value === 'object' && value !== null) {
            const $expandBtn = $('<button>', {
                class: 'expand-collapse-btn',
                text: '+'
            });

            const $jsonPreview = $('<span>', {
                class: 'expandable-json',
                text: Array.isArray(value) ?
                    `Array[${value.length}]` :
                    `Object{${Object.keys(value).length} properties}`
            });

            const $container = $('<div>');
            $container.append($expandBtn, $jsonPreview);

            const $nestedContainer = $('<div>', {
                class: 'nested-table',
                css: { display: 'none' }
            });

            if (Array.isArray(value)) {
                createArrayTable(value, $nestedContainer);
            } else {
                createObjectTable(value, $nestedContainer);
            }

            $container.append($nestedContainer);
            $parentElement.append($container);

            $expandBtn.on('click', function() {
                if ($nestedContainer.css('display') === 'none') {
                    $nestedContainer.css('display', 'block');
                    $expandBtn.text('-');
                } else {
                    $nestedContainer.css('display', 'none');
                    $expandBtn.text('+');
                }
            });
        } else {
            let jsonValue;
            if (typeof value === 'string' && ((jsonValue = asJsonObject(value)) !== null)) {
                try {
                    createExpandableJson(jsonValue, $parentElement);
                } catch (e) {
                    $parentElement.text(String(value));
                }
            } else {
                $parentElement.text(value !== null ? value && String(value) || '' : 'null');
            }
        }
    }

    // Function to create a table for an array
    function createArrayTable(arr, $container) {
        if (arr.length === 0) {
            const $emptyMsg = $('<div>', {
                text: '[empty array]',
                css: {
                    fontStyle: 'italic',
                    color: '#aaa'
                }
            });
            $container.append($emptyMsg);
            return;
        }

        const $tableContainer = $('<div>', { class: 'table-container' });
        const $table = $('<table>');

        // Determine if we need a complex table or a simple list
        let isComplexArray = false;
        for (const item of arr) {
            if (typeof item === 'object' && item !== null) {
                isComplexArray = true;
                break;
            }
        }

        if (isComplexArray) {
            // Create header with all possible keys
            const keys = new Set();
            $.each(arr, function(_, item) {
                if (typeof item === 'object' && item !== null) {
                    $.each(item, function(key) {
                        keys.add(key);
                    });
                }
            });

            const $thead = $('<thead>');
            const $headerRow = $('<tr>');

            keys.forEach(key => {
                const $th = $('<th>', { text: capitalize(key) });
                $headerRow.append($th);
            });

            $thead.append($headerRow);
            $table.append($thead);

            // Create table body
            const $tbody = $('<tbody>');

            $.each(arr, function(_, item) {
                if (typeof item === 'object' && item !== null) {
                    const $row = $('<tr>');

                    keys.forEach(key => {
                        const $td = $('<td>');
                        const value = item[key];
                        createExpandableJson(value, $td);
                        $row.append($td);
                    });

                    $tbody.append($row);
                }
            });

            $table.append($tbody);
        } else {
            // Simple list for primitive values
            const $tbody = $('<tbody>');

            $.each(arr, function(index, item) {
                const $row = $('<tr>');

                const $indexCell = $('<td>', {
                    text: index,
                    css: { width: '50px' }
                });
                $row.append($indexCell);

                const $valueCell = $('<td>', {
                    text: item !== null ? String(item) : 'null'
                });
                $row.append($valueCell);

                $tbody.append($row);
            });

            const $thead = $('<thead>');
            const $headerRow = $('<tr>');

            $headerRow.append(
                $('<th>', { text: 'Index' }),
                $('<th>', { text: 'Value' })
            );

            $thead.append($headerRow);
            $table.append($thead, $tbody);
        }

        $tableContainer.append($table);
        $container.append($tableContainer);
    }

    // Function to create a table for an object
    function createObjectTable(obj, $container) {
        const $tableContainer = $('<div>', { class: 'table-container' });
        const $table = $('<table>');
        const $thead = $('<thead>');
        const $headerRow = $('<tr>');

        $headerRow.append(
            $('<th>', { text: 'Property' }),
            $('<th>', { text: 'Value' })
        );

        $thead.append($headerRow);
        $table.append($thead);

        const $tbody = $('<tbody>');

        $.each(obj, function(key, value) {
            const $row = $('<tr>');

            const $keyCell = $('<td>', {
                text: key,
                css: { width: '30%' }
            });
            $row.append($keyCell);

            const $valueCell = $('<td>');
            createExpandableJson(value, $valueCell);
            $row.append($valueCell);

            $tbody.append($row);
        });

        $table.append($tbody);
        $tableContainer.append($table);
        $container.append($tableContainer);
    }

    // Function to add JSON data as a table
    function addDataMessage(jsonData) {
        const $messageDiv = $('<div>', { class: 'message data-message' });

        try {
            const data = JSON.parse(jsonData);

            if (Array.isArray(data)) {
                const $container = $('<div>');
                createArrayTable(data, $container);
                $messageDiv.append($container);
            } else if (typeof data === 'object' && data !== null) {
                const $container = $('<div>');
                createObjectTable(data, $container);
                $messageDiv.append($container);
            } else {
                // Not an array or object
                $messageDiv.text(jsonData);
            }
        } catch (e) {
            // If parsing fails, just show the raw response
            $messageDiv.text(jsonData);
        }

        $chatContainer.append($messageDiv);
        $chatContainer.scrollTop($chatContainer[0].scrollHeight);
        updateClearButtonVisibility();
    }

    // Show and hide loading indicator
    function showLoading() {
        const $loadingDiv = $('<div>', {
            class: 'loading-container',
            id: 'loading-message',
            html: '<div class="loading"></div>'
        });
        $chatContainer.append($loadingDiv);
        $chatContainer.scrollTop($chatContainer[0].scrollHeight);
    }

    function hideLoading() {
        const $loadingMessage = $('#loading-message');
        if ($loadingMessage.length) {
            $loadingMessage.css({
                position: 'absolute',
                transition: 'opacity 0.5s',
                opacity: '0'
            });

            // Remove completely after animation
            setTimeout(() => {
                $loadingMessage.remove();
            }, 500);
        }
    }

    function capitalize(str) {
        const splitStr = str.toLowerCase().split(' ');
        for (let i = 0; i < splitStr.length; i++) {
            splitStr[i] = splitStr[i].charAt(0).toUpperCase() + splitStr[i].slice(1);
        }
        return splitStr.join(' ');
    }

    // Send a message to the Ask API
    async function sendAskMessage(message) {
        if (message.trim() === '') return;

        addMessage(message, true);
        $messageInput.val('');
        showLoading();

        try {
            const response = await $.ajax({
                url: `/assistant/ask?query=${encodeURIComponent(message)}`,
                type: 'GET'
            });

            hideLoading();
            addMessage(response, false);
        } catch (error) {
            hideLoading();
            addMessage(`Sorry, there was an error processing your request: ${error.statusText || error.message}`, false);
            console.error('Error:', error);
        }
    }

    // Send a message to the JSON API
    async function sendDataMessage(message) {
        if (message.trim() === '') return;

        addMessage(message, true);
        $messageInput.val('');
        showLoading();

        try {
            const data = await $.ajax({
                url: `/assistant/json?query=${encodeURIComponent(message)}`,
                type: 'GET'
            });

            hideLoading();
            addDataMessage(data);
        } catch (error) {
            hideLoading();
            addMessage(`Sorry, there was an error processing your request: ${error.statusText || error.message}`, false);
            console.error('Error:', error);
        }
    }

    // Clear chat history
    async function clearChat() {
        try {
            await $.ajax({
                url: '/assistant/clear',
                type: 'GET'
            });

            // Keep only the initial greeting
            while ($chatContainer.children().length > 1) {
                $chatContainer.children().last().remove();
            }

            updateClearButtonVisibility();
        } catch (error) {
            console.error('Error clearing chat:', error);
        }
    }

    // Event listeners
    $('#ask-button').on('click', function() {
        sendAskMessage($messageInput.val());
    });

    $('#data-button').on('click', function() {
        sendDataMessage($messageInput.val());
    });

    $messageInput.on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            // Default to "Ask" when pressing Enter
            sendAskMessage($messageInput.val());
        }
    });

    $clearButton.on('click', clearChat);

    // Initialize
    updateClearButtonVisibility();
});
</script>
</body>
</html>