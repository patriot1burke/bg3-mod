<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baldur's Forge Assistant Chat</title>
    <link rel="stylesheet" href="/webjars/font-awesome/css/all.min.css">
    <script src="/webjars/jquery/jquery.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .rarity-legendary {
            color: #B7861D;
        }

        .rarity-veryrare {
            color: #D1017B;
        }

        .rarity-rare {
            color: #01BFFF;
        }

        .rarity-uncommon {
            color: #01BD39;
        }

        .rarity-common {
            color: #FFFFFF;
        }


        body {
            height: 100vh;
            overflow: hidden;
            background-color: #333639;
            color: #e8e8e8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .banner {
            height: 70px;
            background-color: #333639;
            color: white;
            display: flex;
            align-items: center;
            justify-content: left;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 100;
            border-bottom: 3px solid #BCAE79;
        }
        .banner img {
            height: 40px;
            margin-right: 15px;
        }
  
        .main-content {
            height: calc(100vh - 70px);
            display: flex;
        }

        .container {
            display: flex;
            height: 100%;
            width: 100%;
        }

        .left-panel {
            width: 70%;
            border-right: 2px solid #BCAE79;
            padding: 20px;
            overflow-y: auto;
        }

        .right-container {
            width: 30%;
            display: flex;
            flex-direction: column;
        }

        .top-right-panel {
            height: 50%;
            border-bottom: 2px solid #BCAE79;
            padding: 20px;
            overflow-y: auto;
        }

        .bottom-right-panel {
            height: 50%;
            padding: 20px;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .panel-content {
            line-height: 1.6;
        }

        /* Optional: Add some sample content styling */
        .sample-content {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 90px;
            height: calc(100% - 60px);
            background-color: transparent;
        }
        .input-container {
            position: fixed;
            bottom: 20px;
            left: 2%;
            /*transform: translateX(-50%)*/
            width: 65%;
            max-width: 1160px;
            display: flex;
            background-color: #444750;
            border-radius: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            padding: 5px;
        }
        #message-input {
            flex-grow: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            background-color: transparent;
            color: #e8e8e8;
            outline: none;
        }
        #message-input::placeholder {
            color: #aaa;
        }
        .button-group {
            display: flex;
            padding-right: 10px;
            align-items: center;
        }
        .btn {
            width: 38px;
            height: 38px;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #ask-button {
            background-color: #59666C;
        }
        #ask-button:hover {
            background-color: #4a575c;
        }
        #search-button {
            background-color: #59666C;
        }
        #search-button:hover {
            background-color: #4a575c;
        }
        #data-button {
            background-color: #BCAE79;
            color: #333;
        }
        #data-button:hover {
            background-color: #a89c69;
        }
        .btn i {
            font-size: 18px;
        }
        .clear-btn {
            background: none;
            border: none;
            color: #aaaaaa;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
        }
        .clear-btn:hover {
            color: #e8e8e8;
        }
        .clear-btn i {
            font-size: 18px;
        }
        .message {
            margin-bottom: 20px;
            max-width: 90%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #4e5c64;
            margin-left: auto;
            border-radius: 18px;
            border-bottom-right-radius: 4px;
            color: #fff;
            padding: 12px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .assistant-message {
            margin-right: auto;
            color: #e8e8e8;
            padding: 0 0 0 15px;
            border-left: 3px solid #59666C;
        }
        .data-message {
            margin-right: auto;
            color: #e8e8e8;
            padding: 0 0 0 15px;
            border-left: 3px solid #BCAE79;
            max-width: 90%;
        }
        .loading-container {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            transition: opacity 0.5s ease-out;
            position: relative;
        }
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(188,174,121,0.2);
            border-radius: 50%;
            border-top-color: #BCAE79;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            margin-top: 5px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        pre {
            background-color: #2a2d30;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
            color: #e8e8e8;
            border-left: 2px solid #BCAE79;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 14px;
            background-color: #2a2d30;
        }
        table th {
            background-color: #59666C;
            color: white;
            text-align: left;
            padding: 8px;
            border: 1px solid #444;
        }
        table td {
            padding: 8px;
            border: 1px solid #444;
            color: #e8e8e8;
        }
        table tr:nth-child(even) {
            background-color: #333639;
        }
        .table-container {
            overflow-x: auto;
            max-width: 100%;
        }
        .expandable-json {
            cursor: pointer;
            color: #BCAE79;
            text-decoration: underline;
            font-style: italic;
        }
        .nested-table {
            margin-top: 8px;
            margin-left: 15px;
            border-left: 2px solid #BCAE79;
        }
        .expand-collapse-btn {
            background: none;
            border: none;
            color: #BCAE79;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 5px;
            margin-right: 5px;
        }

        /* Tooltip/Popup styles */
        .tooltip {
            position: absolute;
            background-color: #2a2d30;
            background-image: linear-gradient(to bottom, #54003299, #1B1A1999, #1B1A1999, #40295199);
            border: 1px solid #BCAE79;
            border-radius: 8px;
            padding: 12px;
            max-width: 450px;
            min-width: 450px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            font-size: 14px;
            line-height: 1.4;
            color: #e8e8e8;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            overflow: visible;
            font-family: Times New Roman, serif;
        }

        .tooltip.pinned {
            pointer-events: auto;
            border-color: #a89c69;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
        }

        .tooltip-close {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 16px;
            padding: 2px;
            border-radius: 3px;
            display: none;
        }

        .tooltip.pinned .tooltip-close {
            display: block;
        }

        .tooltip-close:hover {
            color: #e8e8e8;
            background-color: #444;
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip-title {
            /*font-weight: bold;*/
            color: #BCAE79;
            margin-bottom: 100px;
            font-size: 20px;
        }

        .tooltip-content {
            margin-bottom: 8px;
            font-size:  16px;
            background-color: #3a3a3a;
        }

        .tooltip-footer {
            font-size: 12px;
            font-style: italic;
            color: #aaa;
            border-top: 1px solid #444;
            padding-top: 8px;
            margin-top: 8px;
        }

        .tooltip-link {
            color: #BCAE79;
            text-decoration: underline;
            cursor: pointer;
        }

        .tooltip-link:hover {
            color: #a89c69;
        }

        /* List styling */
        ul {
            margin-left: 20px;
            padding-left: 10px;
        }

        ul li {
            margin-bottom: 5px;
        }

        .tool-results-list {
            margin-left: 25px;
            padding-left: 15px;
            list-style-type: disc;
        }

        .tool-results-list li {
            margin-bottom: 8px;
            line-height: 1.4;
            color: #e8e8e8;
        }

               .rarity-legendary {
            color: #B7861D;
        }

        .rarity-veryrare {
            color: #D1017B;
        }

        .rarity-rare {
            color: #01BFFF;
        }

        .rarity-uncommon {
            color: #01BD39;
        }

        .rarity-common {
            color: #FFFFFF;
        }

        .tooltip-ac-value {
            display: grid;
            justify-items: start;
            align-items: start;
            margin-bottom: 8px;
            border-bottom: 1px solid #444;
        }
        .tooltip-ac-value > div {
            grid-column-start: 1;
            grid-row-start: 1;
        }
        .tooltip-ac-value .ac-value {
            font-size: 16px;
            text-align: center;
            width: 45px;
            align-self: center;
            padding-bottom: 1ch;
        }
        
        .tooltip-ac-value .ac-value-comment {
            font-size: 16px;
            padding-left: 1ch;
            padding-bottom: 1ch;
            grid-column-start: 2;
            grid-row-start: 1;
            align-self: center;
        }

        .tooltip-item-image {
            position: absolute;
            top: -9px;
            right: -9px;
            width: 144px;
            height: 144px;
            z-index: 1001;
            pointer-events: none;
            background-color: transparent;
        }


    </style>
</head>

<body>
    <!-- Banner across the top -->
    <div class="banner">
        <img src="/favicon.ico" alt="Baldur's Gate 3 Logo">
        Baldur's Forge Assistant
    </div>

    <!-- Main content area -->
    <div class="main-content">
        <div class="container">
            <!-- Left Panel (50% width) -->
            <div class="left-panel">
                <div class="chat-container" id="chat-container">
                    <div class="message assistant-message">
                        Hello! I'm your Baldur's Forge Assistant. Ask me anything about Baldur's Gate 3 items. <a data-tooltip='{"title":"Helmet of Arcane Acuity","content":"<p>Dexterity Saving Throws +1</p>","footer":"Subtle magics are woven into the helmet&apos;s leather panes - for a powerful offence is sometimes still the best defence."}'>Helmet of Arcane Acuity</a>
                    </div>
                </div>
                <div class="input-container">
                    <input type="text" id="message-input" placeholder="Ask a question about your data..."
                           autocomplete="off" autofocus>
                    <div class="button-group">
                        <button id="ask-button" class="btn" title="Ask a question">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button id="data-button" class="btn" title="Get data">
                            <i class="fas fa-table"></i>
                        </button>
                        <button id="search-button" class="btn" title="Search">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                        

            </div>

            <!-- Right Container (50% width, split vertically) -->
            <div class="right-container">
                <!-- Top Right Panel (50% height of right side) -->
                <div class="top-right-panel">
                    <div class="panel-title">Top Right Panel</div>
                    <div class="panel-content">
                        <div class="sample-content">
                            <img src="/static/img/icons/items-tooltip/Item_MAG_Giantslayer_Greatsword.144.png"/>
                        </div>
                     </div>
                </div>

                <!-- Bottom Right Panel (50% height of right side) -->
                <div class="bottom-right-panel">
                    <div class="panel-title">Bottom Right Panel</div>
                    <div class="panel-content">
                        <div class="sample-content">
                            <h3>Bottom Right Content</h3>
                            <p>This panel takes up the bottom 50% of the right side.</p>
                        </div>
                        <div class="sample-content">
                            <p>Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit
                                anim id est laborum.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip container -->
    <div id="tooltip" class="tooltip">
        <button class="tooltip-close" title="Close tooltip (Esc)">Ã—</button>
        <img class="tooltip-item-image" id="tooltip-item-image" src="/static/img/icons/items-tooltip/Item_MAG_Giantslayer_Greatsword.144.png" alt="Item Image">
        <div class="tooltip-title"></div>
        <div class="tooltip-ac-value" style="grid-template-columns: 42px 1fr">
            <div><img src="/img/armor_class.png"/ width="45" height="45"></div>
            <div class="ac-value"></div>
            <div class="ac-value-comment"></div>
        </div>
        <div class="tooltip-content"></div>
        <div class="tooltip-footer"></div>
    </div>

    <script>
        $(document).ready(function() {
            const $chatContainer = $('#chat-container');
            const $messageInput = $('#message-input');
         
            // Add clear button to chat container
            const $clearButton = $('<button>', {
                id: 'clear-button',
                class: 'clear-btn',
                html: '<i class="fas fa-trash"></i>',
                css: { display: 'none' }
            });
        
            // Function to update clear button visibility
            function updateClearButtonVisibility() {
                if ($chatContainer.children().length > 2) {
                    $clearButton.css('display', 'flex');
                    $chatContainer.append($clearButton);
                } else {
                    $clearButton.css('display', 'none');
                }
            }
        
            // Function to add a message to the chat
            function addMessage(text, isUser) {
                const $messageDiv = $('<div>', {
                    class: `message ${isUser ? 'user-message' : 'assistant-message'}`
                });
        
                // Basic Markdown-like formatting for code blocks
                $messageDiv.html(text.replace(/```([\s\S]*?)```/g, '<pre>$1</pre>'));
        
                $chatContainer.append($messageDiv);
                $chatContainer.scrollTop($chatContainer[0].scrollHeight);
                updateClearButtonVisibility();
            }
        
            // Convert a string to a JSON object if possible
            function asJsonObject(str) {
                try {
                    const json = JSON.parse(str);
                    return typeof json === 'object' && json;
                } catch (e) {
                    return null;
                }
            }
        
            // Function to create expandable JSON cells
            function createExpandableJson(value, $parentElement) {
                if (typeof value === 'object' && value !== null) {
                    const $expandBtn = $('<button>', {
                        class: 'expand-collapse-btn',
                        text: '+'
                    });
        
                    const $jsonPreview = $('<span>', {
                        class: 'expandable-json',
                        text: Array.isArray(value) ?
                            `Array[${value.length}]` :
                            `Object{${Object.keys(value).length} properties}`
                    });
        
                    const $container = $('<div>');
                    $container.append($expandBtn, $jsonPreview);
        
                    const $nestedContainer = $('<div>', {
                        class: 'nested-table',
                        css: { display: 'none' }
                    });
        
                    if (Array.isArray(value)) {
                        createArrayTable(value, $nestedContainer);
                    } else {
                        createObjectTable(value, $nestedContainer);
                    }
        
                    $container.append($nestedContainer);
                    $parentElement.append($container);
        
                    $expandBtn.on('click', function() {
                        if ($nestedContainer.css('display') === 'none') {
                            $nestedContainer.css('display', 'block');
                            $expandBtn.text('-');
                        } else {
                            $nestedContainer.css('display', 'none');
                            $expandBtn.text('+');
                        }
                    });
                } else {
                    let jsonValue;
                    if (typeof value === 'string' && ((jsonValue = asJsonObject(value)) !== null)) {
                        try {
                            createExpandableJson(jsonValue, $parentElement);
                        } catch (e) {
                            $parentElement.text(String(value));
                        }
                    } else {
                        $parentElement.text(value !== null ? value && String(value) || '' : 'null');
                    }
                }
            }
        
            // Function to create a table for an array
            function createArrayTable(arr, $container) {
                if (arr.length === 0) {
                    const $emptyMsg = $('<div>', {
                        text: '[empty array]',
                        css: {
                            fontStyle: 'italic',
                            color: '#aaa'
                        }
                    });
                    $container.append($emptyMsg);
                    return;
                }
        
                const $tableContainer = $('<div>', { class: 'table-container' });
                const $table = $('<table>');
        
                // Determine if we need a complex table or a simple list
                let isComplexArray = false;
                for (const item of arr) {
                    if (typeof item === 'object' && item !== null) {
                        isComplexArray = true;
                        break;
                    }
                }
        
                if (isComplexArray) {
                    // Create header with all possible keys
                    const keys = new Set();
                    $.each(arr, function(_, item) {
                        if (typeof item === 'object' && item !== null) {
                            $.each(item, function(key) {
                                keys.add(key);
                            });
                        }
                    });
        
                    const $thead = $('<thead>');
                    const $headerRow = $('<tr>');
        
                    keys.forEach(key => {
                        const $th = $('<th>', { text: capitalize(key) });
                        $headerRow.append($th);
                    });
        
                    $thead.append($headerRow);
                    $table.append($thead);
        
                    // Create table body
                    const $tbody = $('<tbody>');
        
                    $.each(arr, function(_, item) {
                        if (typeof item === 'object' && item !== null) {
                            const $row = $('<tr>');
        
                            keys.forEach(key => {
                                const $td = $('<td>');
                                const value = item[key];
                                createExpandableJson(value, $td);
                                $row.append($td);
                            });
        
                            $tbody.append($row);
                        }
                    });
        
                    $table.append($tbody);
                } else {
                    // Simple list for primitive values
                    const $tbody = $('<tbody>');
        
                    $.each(arr, function(index, item) {
                        const $row = $('<tr>');
        
                        const $indexCell = $('<td>', {
                            text: index,
                            css: { width: '50px' }
                        });
                        $row.append($indexCell);
        
                        const $valueCell = $('<td>', {
                            text: item !== null ? String(item) : 'null'
                        });
                        $row.append($valueCell);
        
                        $tbody.append($row);
                    });
        
                    const $thead = $('<thead>');
                    const $headerRow = $('<tr>');
        
                    $headerRow.append(
                        $('<th>', { text: 'Index' }),
                        $('<th>', { text: 'Value' })
                    );
        
                    $thead.append($headerRow);
                    $table.append($thead, $tbody);
                }
        
                $tableContainer.append($table);
                $container.append($tableContainer);
            }
        
            // Function to create a table for an object
            function createObjectTable(obj, $container) {
                const $tableContainer = $('<div>', { class: 'table-container' });
                const $table = $('<table>');
                const $thead = $('<thead>');
                const $headerRow = $('<tr>');
        
                $headerRow.append(
                    $('<th>', { text: 'Property' }),
                    $('<th>', { text: 'Value' })
                );
        
                $thead.append($headerRow);
                $table.append($thead);
        
                const $tbody = $('<tbody>');
        
                $.each(obj, function(key, value) {
                    const $row = $('<tr>');
        
                    const $keyCell = $('<td>', {
                        text: key,
                        css: { width: '30%' }
                    });
                    $row.append($keyCell);
        
                    const $valueCell = $('<td>');
                    createExpandableJson(value, $valueCell);
                    $row.append($valueCell);
        
                    $tbody.append($row);
                });
        
                $table.append($tbody);
                $tableContainer.append($table);
                $container.append($tableContainer);
            }
        
            // Function to add JSON data as a table
            function addDataMessage(jsonData) {
                const $messageDiv = $('<div>', { class: 'message data-message' });
        
                try {
                    const data = JSON.parse(jsonData);
        
                    if (Array.isArray(data)) {
                        const $container = $('<div>');
                        createArrayTable(data, $container);
                        $messageDiv.append($container);
                    } else if (typeof data === 'object' && data !== null) {
                        const $container = $('<div>');
                        createObjectTable(data, $container);
                        $messageDiv.append($container);
                    } else {
                        // Not an array or object
                        $messageDiv.text(jsonData);
                    }
                } catch (e) {
                    // If parsing fails, just show the raw response
                    $messageDiv.text(jsonData);
                }
        
                $chatContainer.append($messageDiv);
                $chatContainer.scrollTop($chatContainer[0].scrollHeight);
                updateClearButtonVisibility();
            }

            function searchAndSummary(data) {
                const items = data.response.items;
                const $resultDev = $('<div>', {
                    class: `message assistant-message`
                });
      
                const $list = $('<ul>', { class: 'tool-results-list' });
                for (const item of items) {
                    const $listItem = $('<li>');
                    const $itemAnchor =  $('<a>', {
                        text: item.name,
                        class: `rarity-${item.rarity.toLowerCase()}`
                    });
                    $itemAnchor.data("equipment", item);
                    $itemAnchor.attr('equipment-tooltip', item.name);
                    $listItem.append($itemAnchor);
                    $list.append($listItem);
                }
                const $paragraph = $('<p>');
                $paragraph.append($list);
                $resultDev.append($paragraph);

                const $summaryDiv = $('<div>');                    
                $summaryDiv.html(data.response.summary);
                $resultDev.append($summaryDiv);
                $chatContainer.append($resultDev);
            }

            function findByName(data) {
                const equipment = data.response;
                if (!equipment) {
                    const $messageDiv = $('<div>', { class: 'message data-message' });
                    const $notFoundDiv = $('<div>');
                    $notFoundDiv.html('No equipment found');
                    $messageDiv.append($notFoundDiv);
                    $chatContainer.append($messageDiv);
                    return;
                }
                console.log(equipment);
                const $resultDev = $('<div>', {
                    class: `message assistant-message`
                });
                const $equipmentPanel = $baseEquipmentPanel.clone();
                $equipmentPanel.css('position', 'relative');
                showEquipmentPanel($equipmentPanel, equipment);
                $resultDev.append($equipmentPanel);
                $equipmentPanel.addClass('show');
                $chatContainer.append($resultDev);
            }

                       // Function to add JSON data as a table
            function addToolMessage(jsonData) {
        
                try {
                    const data = JSON.parse(jsonData);
                    for (const toolResult of data) {
                        if (toolResult.tool === 'searchAndSummary') {
                            searchAndSummary(toolResult);
                        } else if (toolResult.tool === 'findByName') {
                            findByName(toolResult);
                        } else {
                            addDataMessage(toolResult);
                        }
                    }
                } catch (e) {
                    // If parsing fails, just show the raw response
                    const $messageDiv = $('<div>', { class: 'message data-message' });
                    $messageDiv.text(jsonData);
                    $chatContainer.append($messageDiv);
                }
        
                $chatContainer.scrollTop($chatContainer[0].scrollHeight);
                updateClearButtonVisibility();
            }
        
            // Show and hide loading indicator
            function showLoading() {
                const $loadingDiv = $('<div>', {
                    class: 'loading-container',
                    id: 'loading-message',
                    html: '<div class="loading"></div>'
                });
                $chatContainer.append($loadingDiv);
                $chatContainer.scrollTop($chatContainer[0].scrollHeight);
            }
        
            function hideLoading() {
                const $loadingMessage = $('#loading-message');
                if ($loadingMessage.length) {
                    $loadingMessage.css({
                        position: 'absolute',
                        transition: 'opacity 0.5s',
                        opacity: '0'
                    });
        
                    // Remove completely after animation
                    setTimeout(() => {
                        $loadingMessage.remove();
                    }, 500);
                }
            }
        
            function capitalize(str) {
                const splitStr = str.toLowerCase().split(' ');
                for (let i = 0; i < splitStr.length; i++) {
                    splitStr[i] = splitStr[i].charAt(0).toUpperCase() + splitStr[i].slice(1);
                }
                return splitStr.join(' ');
            }
        
            // Send a message to the Ask API
            async function sendAskMessage(message) {
                if (message.trim() === '') return;
        
                addMessage(message, true);
                $messageInput.val('');
                showLoading();
        
                try {
                    const response = await $.ajax({
                        url: `/assistant/ask?query=${encodeURIComponent(message)}`,
                        type: 'GET'
                    });
        
                    hideLoading();
                    addMessage(response, false);
                } catch (error) {
                    hideLoading();
                    addMessage(`Sorry, there was an error processing your request: ${error.statusText || error.message}`, false);
                    console.error('Error:', error);
                }
            }
        
            // Send a message to the JSON API
            async function sendDataMessage(message) {
                if (message.trim() === '') return;
        
                addMessage(message, true);
                $messageInput.val('');
                showLoading();
        
                try {
                    const data = await $.ajax({
                        url: `/assistant/json?query=${encodeURIComponent(message)}`,
                        type: 'GET'
                    });
        
                    hideLoading();
                    addDataMessage(data);
                } catch (error) {
                    hideLoading();
                    addMessage(`Sorry, there was an error processing your request: ${error.statusText || error.message}`, false);
                    console.error('Error:', error);
                }
            }

            async function sendToolMessage(message) {
                if (message.trim() === '') return;
        
                addMessage(message, true);
                $messageInput.val('');
                showLoading();
        
                try {
                    const data = await $.ajax({
                        url: `/assistant/json?query=${encodeURIComponent(message)}`,
                        type: 'GET'
                    });
        
                    hideLoading();
                    addToolMessage(data);
                } catch (error) {
                    hideLoading();
                    addMessage(`Sorry, there was an error processing your request: ${error.statusText || error.message}`, false);
                    console.error('Error:', error);
                }
            }
        
            // Clear chat history
            async function clearChat() {
                try {
                    await $.ajax({
                        url: '/assistant/clear',
                        type: 'GET'
                    });
        
                    // Keep only the initial greeting
                    while ($chatContainer.children().length > 1) {
                        $chatContainer.children().last().remove();
                    }
        
                    updateClearButtonVisibility();
                } catch (error) {
                    console.error('Error clearing chat:', error);
                }
            }
        
            // Event listeners
            $('#ask-button').on('click', function() {
                sendAskMessage($messageInput.val());
            });
        
            $('#data-button').on('click', function() {
                sendDataMessage($messageInput.val());
            });
        
            $('#search-button').on('click', function() {
                sendToolMessage($messageInput.val());
            });

            $messageInput.on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    // Default to "Ask" when pressing Enter
                    sendAskMessage($messageInput.val());
                }
            });
        
            $clearButton.on('click', clearChat);
        
            // Initialize
            updateClearButtonVisibility();

            // Tooltip functionality
            const $tooltip = $('#tooltip');
            let tooltipTimeout;
            let isTooltipPinned = false;
            const $baseEquipmentPanel = $tooltip.clone();

            function showEquipmentPanel(tooltip, equipment) {
                const $tooltipTitle = tooltip.find('.tooltip-title');
                const $tooltipArmorClass = tooltip.find('.tooltip-ac-value');
                const $tooltipContent = tooltip.find('.tooltip-content');
                const $tooltipFooter = tooltip.find('.tooltip-footer');
                const $tooltipImage = tooltip.find('.tooltip-item-image');

                if (equipment.icon) {
                    $tooltipImage.attr('src', '/static/img/icons/items-tooltip/' + equipment.icon + '.144.png');
                } else {
                    $tooltipImage.hide();
                }

                if (equipment.slot === 'Breast') {
                    ac = equipment.armorClass;
                    const $armorClassDiv = $tooltipArmorClass.find('.ac-value');
                    const $armorClassCommentDiv = $tooltipArmorClass.find('.ac-value-comment');

                    $armorClassDiv.html(`<b>${ac}</b>`);
                    $armorClassCommentDiv.html('<b>Armour Class</b>');
                    $tooltipArmorClass.show();
                } else {
                    $tooltipArmorClass.hide();
                }
                content = '';
                content += `${equipment.boostDescription}`;

                 // Set content
                $tooltipTitle.html(equipment.name || '');
                $tooltipContent.html(content);
                $tooltipFooter.html(equipment.description || '');

                // Set tooltip title color programmatically
                if (equipment.rarity === 'Legendary') {
                    tooltip.css('background-image', 'linear-gradient(to bottom, #563E0D99, #1B1A1999, #1B1A1999, #40295199')
                    $tooltipTitle.attr('class', 'rarity-legendary tooltip-title');
                } else if (equipment.rarity === 'VeryRare') {
                    tooltip.css('background-image', 'linear-gradient(to bottom, #54003299, #1B1A1999, #1B1A1999, #40295199')
                    $tooltipTitle.attr('class', 'rarity-veryrare tooltip-title');
                } else if (equipment.rarity === 'Rare') {
                    tooltip.css('background-image', 'linear-gradient(to bottom, #00374999, #1B1A1999, #1B1A1999, #40295199')
                    $tooltipTitle.attr('class', 'tooltip-title rarity-rare');
                } else if (equipment.rarity === 'Uncommon') {
                    tooltip.css('background-image', 'linear-gradient(to bottom, #00491599, #1B1A1999, #1B1A1999, #40295199')
                    $tooltipTitle.attr('class', 'rarity-uncommon tooltip-title');
                } else if (equipment.rarity === 'Common') {
                    tooltip.css('background-image', 'linear-gradient(to bottom, #1B1A1999, #1B1A1999, #1B1A1999, #40295199')
                    $tooltipTitle.attr('class', 'rarity-common tooltip-title');
                } // You can change this color as needed


            }

            // Function to show tooltip
            function showTooltip(event, equipment) {
                showEquipmentPanel($tooltip, equipment);

                // Hide title/footer if empty
                //$tooltipTitle.toggle(!!title);
                //$tooltipFooter.toggle(!!footer);

                // Position tooltip near mouse
                const mouseX = event.pageX;
                const mouseY = event.pageY;
                const tooltipWidth = 250; // Approximate width
                const tooltipHeight = 150; // Approximate height
                const windowWidth = $(window).width();
                const windowHeight = $(window).height();

                let left = mouseX + 15; // Offset from mouse
                let top = mouseY - 10;

                // Adjust if tooltip would go off screen
                if (left + tooltipWidth > windowWidth) {
                    left = mouseX - tooltipWidth - 15;
                }
                if (top + tooltipHeight > windowHeight) {
                    top = mouseY - tooltipHeight + 10;
                }

                $tooltip.css({
                    left: left + 'px',
                    top: top + 'px'
                });

                // Show tooltip
                $tooltip.addClass('show');
            }

            // Function to hide tooltip
            function hideTooltip() {
                if (!isTooltipPinned) {
                    $tooltip.removeClass('show');
                }
            }

            // Function to pin tooltip
            function pinTooltip() {
                isTooltipPinned = true;
                $tooltip.addClass('pinned');
            }

            // Function to unpin tooltip
            function unpinTooltip() {
                isTooltipPinned = false;
                $tooltip.removeClass('pinned show');
            }

            // Add tooltip functionality to elements with data-tooltip attribute
            $(document).on('mouseenter', '[equipment-tooltip]', function(event) {
                if (isTooltipPinned) return; // Don't show new tooltip if one is pinned
                
                const $element = $(this);
                const equipment = $element.data("equipment");
                

                // Clear any existing timeout
                clearTimeout(tooltipTimeout);
                
                // Show tooltip after a small delay
                tooltipTimeout = setTimeout(() => {
                    showTooltip(event, equipment);
                }, 300);
            });

            $(document).on('mouseleave', '[equipment-tooltip]', function() {
                clearTimeout(tooltipTimeout);
                hideTooltip();
            });

            // Click to pin tooltip
            $(document).on('click', '[equipment-tooltip]', function(event) {
                if ($tooltip.hasClass('show') && !isTooltipPinned) {
                    event.preventDefault();
                    pinTooltip();
                }
            });

            // Hide tooltip when moving mouse away (only if not pinned)
            $(document).on('mousemove', function(event) {
                if ($tooltip.hasClass('show') && !isTooltipPinned) {
                    const $hoveredElement = $(event.target);
                    if (!$hoveredElement.closest('[equipment-tooltip]').length) {
                        hideTooltip();
                    }
                }
            });

            // Close button click
            $tooltip.on('click', '.tooltip-close', function() {
                unpinTooltip();
            });

            // Escape key to unpin tooltip
            $(document).on('keydown', function(event) {
                if (event.key === 'Escape' && isTooltipPinned) {
                    unpinTooltip();
                }
            });

        });
</script>
</body>

</html>